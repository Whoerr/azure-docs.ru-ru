---
title: Репликация данных через ExpressRoute с миграцией Azure миграция сервера
description: Использование Azure ExpressRoute для репликации с миграцией Azure миграция сервера
author: ms-deseelam
ms.author: deseelam
ms.manager: bsiva
ms.topic: how-to
ms.date: 02/22/2021
ms.openlocfilehash: fe44ff423240cbe24d91cef0c0f4bb803ad8df98
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101746551"
---
# <a name="replicate-data-over-expressroute-with-azure-migrate-server-migration"></a>Репликация данных через ExpressRoute с помощью службы "миграция Azure": миграция сервера

В этой статье вы узнаете, как настроить [миграцию в Azure: миграция сервера](https://docs.microsoft.com/azure/migrate/migrate-services-overview#azure-migrate-server-migration-tool) для репликации данных через канал ExpressRoute при переносе серверов в Azure.

## <a name="understand-azure-expressroute-circuits"></a>Общие сведения о каналах Azure ExpressRoute
Цепь ExpressRoute (ER) подключает локальную инфраструктуру к корпорации Майкрософт через поставщика услуг подключения. Каналы ExpressRoute можно настроить для использования частного пиринга, пиринга Майкрософт или и того и другого. Дополнительные сведения о различных вариантах пиринга, доступных в ExpressRoute, см. в статье [каналы expressroute и пиринг](https://docs.microsoft.com/azure/expressroute/expressroute-circuit-peerings#peeringcompare) .

Средство миграции серверов в Azure Migration Tool позволяет переносить локальные серверы и серверы из других облаков в виртуальные машины Azure. Это средство работает путем настройки текущего потока репликации для репликации данных с серверов, которые будут перенесены на управляемые диски в подписке Azure. Когда вы будете готовы к миграции серверов, для миграции серверов используется реплицированные данные в Azure.

Данные, реплицированные с локальных серверов, можно настроить для отправки в подписку Azure через Интернет (с помощью защищенного зашифрованного соединения) или через подключение ExpressRoute. При наличии большого количества серверов для миграции использование ExpressRoute для репликации поможет повысить эффективность миграции серверов с помощью подготовленной пропускной способности, доступной в канале ExpressRoute.

В этой статье вы узнаете
> [!div class="checklist"]
>
> * Как реплицировать данные с помощью канала ExpressRoute с частным пирингом.
> * Как реплицировать данные с помощью канала ExpressRoute и пиринга Майкрософт.

## <a name="replicate-data-using-an-expressroute-circuit-with-private-peering"></a>Репликация данных с помощью канала ExpressRoute с частным пирингом

> [!NOTE]
> Репликация через частный канал пиринга сейчас поддерживается только для [переноса виртуальных машин VMware в Azure без агента](./tutorial-migrate-vmware.md). Поддержка частных конечных точек для других [методов репликации](./migrate-services-overview.md#azure-migrate-server-migration-tool) скоро будет доступна.

В безагентном методе переноса виртуальных машин VMware в Azure устройство "миграция Azure" сначала отправляет данные репликации в учетную запись хранения (учетную запись хранения кэша) в подписке. После этого реплицированные данные из учетной записи хранения кэша перемещаются в управляемые репликами диски в подписке службой "миграция Azure". Чтобы использовать частный канал пиринга для репликации, необходимо создать и присоединить закрытую конечную точку к учетной записи хранения кэша. Частные конечные точки используют один или несколько частных IP-адресов из виртуальной сети (VNet), фактически передавая учетную запись хранения в виртуальную сеть Azure. Частная конечная точка позволяет устройству миграции Azure подключаться к учетной записи хранения кэша с помощью частного пиринга ExpressRoute и передавать данные непосредственно по частному IP-адресу. <br/>  

![Процесс репликации](./media/replicate-using-expressroute/replication-process.png)

> [!Important]
>
> - Помимо данных репликации, устройство службы "миграция Azure" взаимодействует со службой "миграция Azure" для выполнения действий плоскости управления, включая организацию репликации. Взаимодействие плоскости управления между устройством "миграция Azure" и службой "миграция Azure" осуществляется через Интернет в общедоступной конечной точке службы "миграция Azure".
> - Частная конечная точка учетной записи хранения должна быть доступна из сети, в которой развернуто устройство миграции Azure.
> - Служба DNS должна быть настроена для разрешения запросов DNS с помощью устройства "миграция Azure" для конечной точки службы BLOB-объектов учетной записи хранения кэша на частный IP-адрес частной конечной точки, присоединенной к учетной записи хранения кэша.
> - Учетная запись хранения кэша должна быть доступна в общедоступной конечной точке. (Служба "миграция Azure" использует общедоступную конечную точку учетной записи хранения кэша для перемещения данных из учетной записи хранения на управляемые диски реплики.) 


### <a name="1-pre-requisites"></a>1. Предварительные требования

Пользователь Azure, создающий частную конечную точку, должен иметь следующие разрешения для группы ресурсов и виртуальной сети, в которой будет создана частная конечная точка.

**Вариант использования** | **Разрешения** 
--- | --- 
 Создание частных конечных точек и управление ими. | Microsoft. Network/Приватиндпоинт/запись/действие<br/>Microsoft. Network/Приватиндпоинт, чтение и действие  
|Присоедините частную конечную точку к виртуальной сети или подсетью.<br/>Это необходимо в виртуальной сети, в которой будет создана частная конечная точка.| Microsoft. Network/virtualNetworks/подсеть/соединение/действие Microsoft. Network/virtualNetworks/Join/Action
|Свяжите частную конечную точку с учетной записью хранения. <br/>| Microsoft. Microsoft. Storage/storageAccounts/Приватиндпоинтконнектионаппровал/действие <br/> Microsoft. Microsoft. Storage, storageAccounts/Приватиндпоинтконнектионс/Read
|Создайте сетевой интерфейс и присоедините его к группе безопасности сети. | Microsoft.Network/networkInterfaces/read <br/> Microsoft. Network/networkInterfaces/подсети/запись <br/> Microsoft. Network/networkInterfaces/подсети/чтение<br/> Microsoft. Network/networkSecurityGroups/соединение/действие (необязательно)
Создание частных зон DNS и управление ими.| Роль участника зоны Частная зона DNS <br/> _Or_ <br/> Microsoft. Network/Приватеднсзонес/A/* <br/>  Microsoft. Network/Приватеднсзонес/запись Microsoft. Network/Приватеднсзонес/Read <br/> Microsoft. Network/Приватиндпоинтс/Приватеднсзонеграупс/запись <br/> Microsoft. Network/Приватиндпоинтс/Приватеднсзонеграупс/чтение <br/> Microsoft. Network/Приватеднсзонес/Виртуалнетворклинкс/запись <br/>  Microsoft. Network/Приватеднсзонес/Виртуалнетворклинкс/чтение <br/> Microsoft. Network/virtualNetworks/соединение/действие 

### <a name="2-identify-the-cache-storage-account"></a>2. Указание учетной записи хранения кэша 
 
Служба "миграция Azure" автоматически создает учетную запись хранения кэша при настройке репликации (с помощью портал Azure интерфейса) для виртуальной машины в первый раз в проекте службы "миграция Azure". Учетная запись хранения создается в той же подписке и группе ресурсов, в которой вы создали проект "миграция Azure" в.

Чтобы создать и указать учетную запись хранения, сделайте следующее:

1. Используйте портал Azure интерфейс для службы "миграция Azure", чтобы реплицировать одну или несколько виртуальных машин в проекте.
2. Перейдите к группе ресурсов проекта "миграция Azure".
3. Нахождение учетной записи хранения кэша путем определения префикса **LSA** в имени учетной записи хранения.

![Представление группы ресурсов](./media/replicate-using-expressroute/storage-account-name.png)

> [!Tip]
> Если у вас есть несколько учетных записей хранения с префиксом **"LSA"** в группе ресурсов, можно проверить учетную запись хранения, перейдя в меню "Параметры репликации" и "Целевая конфигурация" для любой из реплицируемых виртуальных машин в проекте. <br/> 
> ![Общие сведения о параметрах репликации](./media/replicate-using-expressroute/storage-account.png)

### <a name="3-upgrade--cache-storage-account-to-general-purpose-v2"></a>3. обновление учетной записи хранения кэша до общего назначения v2 

Частные конечные точки можно создавать только в учетной записи хранения общего назначения v2 (GPv2). Если учетная запись хранения кэша не является учетной записью хранения GPv2, обновите ее до GPv2, выполнив следующие действия.

1. Войдите в свою учетную запись хранения.
2. Щелкните **Конфигурация**.
3. В разделе **тип учетной записи** выберите **Обновить**.
4. В разделе **Подтверждение обновления** введите имя своей учетной записи.
5. В нижней части страницы выберите **Обновить** .

![Обновление учетной записи хранения](./media/replicate-using-expressroute/upgrade-storage-account.png)

### <a name="4-create-a-private-endpoint-for-the-storage-account"></a>4. Создайте закрытую конечную точку для учетной записи хранения.

1. Перейдите к своей учетной записи хранения, выберите **сеть** в меню слева и перейдите на вкладку **частные конечные точки подключения** .  
2. Щелкните **+ Добавить частную конечную точку**.

    а. В окне **Создание частной конечной точки** — выберите **подписку** и **группу ресурсов**. Укажите имя частной конечной точки и выберите регион учетной записи хранения.  
    ![Окно конфигурации PE](./media/replicate-using-expressroute/storage-account-private-endpoint-creation.png)

    b. На вкладке **ресурс** укажите **имя подписки** , в которой находится учетная запись хранения. Выберите **Microsoft. Storage/storageAccounts** в качестве **типа ресурса**. В поле **ресурс** укажите имя учетной записи хранения для репликации типа GPv2. Выберите **BLOB-объект** в качестве **целевого подресурса**.  
    ![сторажеаккаунтпесеттингс](./media/replicate-using-expressroute/storage-account-private-endpoint-settings.png)

    c. На вкладке **Конфигурация** выберите **виртуальную сеть** и **подсеть** для частной конечной точки учетной записи хранения.  

    > [!Note]
    > Виртуальная сеть должна содержать конечную точку шлюза ExpressRoute или должна быть подключена к виртуальной сети с помощью шлюза ExpressRoute. 

    В разделе **интеграция частная зона DNS** выберите **Да** и ИНТЕГРИРУЙТЕ с частной зоной DNS. При выборе параметра **Да** автоматически связывается зона DNS с выбранной виртуальной сетью и добавляются записи DNS, необходимые для разрешения DNS новых IP-адресов и полных доменных имен, созданных для частной конечной точки. Дополнительные сведения о [частных зонах DNS.](https://docs.microsoft.com/azure/dns/private-dns-overview)

    ![приватеднсзоне](./media/replicate-using-expressroute/private-dns-zone.png)

    d. Вы также можете добавить **теги** для частной конечной точки.  

    д) Продолжайте **проверку и создание** после ввода подробностей. По завершении проверки выберите **создать** , чтобы создать частную конечную точку.

    > [!Note]
    > Если пользователь, создающий закрытую конечную точку, также является владельцем учетной записи хранения, Частная конечная точка будет утверждена как автоматическая. В противном случае владелец должен утвердить закрытую конечную точку для использования. 

#### <a name="create-private-dns-zones-and-add-dns-records-manually-optional"></a>Создание частных зон DNS и добавление записей DNS вручную (необязательно)

Если вы не выбрали параметр для интеграции с частной зоной DNS во время создания частной конечной точки, выполните действия, описанные в этом разделе, чтобы вручную создать частную зону DNS. 

> [!Note]
> Если вы выбрали **Да** для интеграции с частной зоной DNS, этот раздел можно пропустить. 

1. Создайте частную зону DNS. 

    ![креатеприватеднс](./media/replicate-using-expressroute/create-private-dns.png)

    а.  На странице **Частная зона DNS зоны** нажмите кнопку **+ Добавить** , чтобы начать создание новой зоны.  
    b.  На странице **Создание частной зоны DNS** введите необходимые сведения. Введите имя частной зоны DNS в формате _привателинк_. BLOB.Core.Windows.NET. c. Перейдите на вкладку " **Проверка и создание** ", чтобы проверить и создать зону DNS.

2. Свяжите частную зону DNS с виртуальной сетью.  

    Частная зона DNS, созданная выше, должна быть связана с виртуальной сетью, к которой подключена частная конечная точка.

    а. Перейдите к частной зоне DNS, созданной на предыдущем шаге, и перейдите к разделу ссылки виртуальной сети в левой части страницы. Нажмите кнопку **+ Добавить** .   
    b. Введите необходимые сведения. Поля **Подписка** и **Виртуальная сеть** должны быть заполнены соответствующими сведениями о виртуальной сети, к которой подключена частная конечная точка. Остальные поля можно оставить как есть.

3. Следующим шагом является добавление записей DNS в зону DNS. Добавьте запись для полного доменного имени учетной записи хранения в закрытую зону DNS.

    а. Перейдите к частной зоне DNS и перейдите к разделу **Обзор** в левой части страницы. Выберите **+ набор записей** , чтобы начать добавление записей.  

    b. На странице **Добавление набора записей** добавьте запись для полного доменного имени и частный IP-адрес в качестве записи типа.

> [!Important]
> Для разрешения частного IP-адреса частной конечной точки учетной записи хранения из исходной среды могут потребоваться дополнительные параметры DNS. [Ознакомьтесь с этой статьей](https://docs.microsoft.com/azure/private-link/private-endpoint-dns#on-premises-workloads-using-a-dns-forwarder) , чтобы понять, какая конфигурация DNS необходима.

## <a name="replicate-data-using-an-expressroute-circuit-with-microsoft-peering"></a>Репликация данных с помощью канала ExpressRoute и пиринга Майкрософт

Вы можете использовать пиринг Майкрософт или существующий домен общедоступного пиринга (не рекомендуется для новых подключений ExpressRoute) для маршрутизации трафика репликации через канал ExpressRoute, как показано на схеме ниже.
![репликатионвисмикрософтпиринг](./media/replicate-using-expressroute/replication-with-microsoft-peering.png)

Даже если данные репликации переходят через равноправный канал Майкрософт, вам по-прежнему потребуется подключение к Интернету с локального сайта для другой связи (плоскости управления) с помощью службы "миграция Azure". Есть несколько дополнительных URL-адресов, которые недоступны через ExpressRoute, а узлу устройства репликации или Hyper-V требуется доступ для координации процесса репликации. Вы можете ознакомиться с требованиями к URL-адресам, исходя из сценария миграции, [миграций VMware без агента](https://docs.microsoft.com/azure/migrate/migrate-appliance#public-cloud-urls) или [миграций на основе агентов](https://docs.microsoft.com/azure/migrate/migrate-replication-appliance).  

Если вы используете учетную запись-посредник на локальном сайте и хотите использовать ExpressRoute для трафика репликации, необходимо настроить обход прокси-сервера для соответствующих URL-адресов на локальном устройстве. 

### <a name="configure-proxy-bypass-rules-on-the-azure-migrate-appliance-for-vmware-agentless-migrations"></a>Настройка правил обхода прокси-сервера на устройстве "миграция Azure" (для миграций без агента VMware)

1. Войдите в устройство службы "миграция Azure" (удаленный рабочий стол).   
2. Откройте файл C:/папка ProgramData/MicrosoftAzure/config/appliance.jsс помощью блокнота.
3. В файле измените строку с текстом "Енаблепроксибипасслист": "false" на "Енаблепроксибипасслист": "true". Сохраните изменения и перезапустите устройство.
4. После перезапуска при открытии диспетчера конфигурации устройства вы сможете увидеть параметр пропуска прокси в пользовательском интерфейсе веб-приложения. Добавьте указанные ниже URL-адреса в список обхода прокси-сервера.   
    - . *. vault.azure.net
    - . *. servicebus.windows.net
    - . *. discoverysrv.windowsazure.com
    - . *. migration.windowsazure.com
    - . *. hypervrecoverymanager.windowsazure.com
    - . *. blob.core.windows.net

### <a name="configure-proxy-bypass-rules-on-the-replication-appliance-for-agent-based-migrations"></a>Настройка правил обхода прокси-сервера на устройстве репликации (для миграций на основе агентов)

Выполните следующие действия, чтобы настроить список обхода прокси-сервера на сервере конфигурации и серверах обработки:

1. [Скачайте средство PsExec](https://docs.microsoft.com/sysinternals/downloads/psexec) для доступа к контексту пользователя системы.
2. Откройте Internet Explorer в контексте системного пользователя, выполнив следующую командную строку: PsExec-s-i "%Програмфилес%\интернет Explorer\iexplore.exe"
3. Добавьте параметры прокси-сервера в IE.
4. В списке обхода добавьте URL-адрес службы хранилища Azure. *. BLOB. Core. Windows. NET.  

Приведенные выше правила обхода гарантируют, что трафик репликации может проходить через ExpressRoute, а обмен данными управления может проходить через прокси-сервер для Интернета.  

Кроме того, необходимо объявить маршруты в фильтре маршрутов для следующих сообществ BGP, чтобы переносить трафик репликации Azure на канал ExpressRoute, а не через Интернет.  

- Региональное сообщество BGP для исходного региона Azure (регион проекта "миграция Azure")
- Региональное сообщество BGP для целевого региона Azure (регион для миграции)
- Сообщество BGP для Azure Active Directory (12076:5060)

Узнайте больше о [фильтрах маршрутов](https://docs.microsoft.com/azure/expressroute/how-to-routefilter-portal) и списке [сообществ BGP для ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-routing#bgp). 

## <a name="next-steps"></a>Дальнейшие действия

- Дополнительные сведения о [каналах ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-circuit-peerings).
- Дополнительные сведения о [доменах маршрутизации ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-circuit-peerings#peeringcompare).
- Дополнительные сведения о [частных конечных точках](https://docs.microsoft.com/azure/private-link/private-endpoint-overview).