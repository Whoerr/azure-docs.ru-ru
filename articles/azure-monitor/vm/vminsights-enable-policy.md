---
title: Включение аналитики виртуальной машины с помощью политики Azure
description: В этой статье описывается, как включить аналитику ВМ для нескольких виртуальных машин Azure или масштабируемых наборов виртуальных машин с помощью политики Azure.
ms.subservice: ''
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 07/27/2020
ms.openlocfilehash: a63a647f3d76e3cc2616f05fe96d86dbdd36e74d
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101707546"
---
# <a name="enable-vm-insights-by-using-azure-policy"></a>Включение аналитики виртуальной машины с помощью политики Azure
В этой статье объясняется, как включить аналитику VM для виртуальных машин Azure или гибридной виртуальной машины, подключенной к службе "Дуга Azure (Предварительная версия)", с помощью политики Azure. Политика Azure позволяет назначать определения политик, которые устанавливают необходимые агенты для виртуальной машины в среде Azure, и автоматически включать мониторинг виртуальных машин при создании каждой виртуальной машины. VM Insights предоставляет функцию, позволяющую обнаруживать и исправлять несоответствующие требованиям виртуальные машины в вашей среде. Используйте эту функцию вместо непосредственной работы с политикой Azure.

Если вы не знакомы с политикой Azure, ознакомьтесь с краткими сведениями о [развертывании Azure Monitor в масштабе с помощью политики Azure](../deploy-scale.md).

> [!NOTE]
> Чтобы использовать политику Azure с масштабируемыми наборами виртуальных машин Azure или напрямую работать с политикой Azure для включения виртуальных машин Azure, см. статью [развертывание Azure Monitor в масштабе с помощью политики Azure](../deploy-scale.md#azure-monitor-for-vms).

## <a name="prerequisites"></a>Предварительные требования
- [Создание и Настройка рабочей области log Analytics](./vminsights-configure-workspace.md).
- Ознакомьтесь с [поддерживаемыми операционными системами](./vminsights-enable-overview.md#supported-operating-systems) , чтобы убедиться, что операционная система, которую вы включаете, поддерживается. 


## <a name="vm-insights-initiative"></a>Инициатива VM Insights
Служба VM Insights предоставляет встроенные определения политик для установки агента Log Analytics и агента зависимостей на виртуальных машинах Azure. Инициатива **Включение Application Insights** включает каждое из этих определений политик. Назначьте эту инициативу группе управления, подписке или группе ресурсов для автоматической установки агентов на всех виртуальных машинах Windows или Linux в этой области.

## <a name="open-policy-coverage-feature"></a>Открыть функцию покрытия политики
Чтобы получить доступ к **покрытию политики VM Insights**, перейдите на **виртуальные машины** в меню **Azure Monitor** в портал Azure. Выберите **другие параметры адаптации** , а затем **включите** в разделе **включить использование политики**.

[![Вкладка "Начало работы" Azure Monitor с виртуальных машин](./media/vminsights-enable-policy/get-started-page.png)](./media/vminsights-enable-policy/get-started-page.png#lightbox)

## <a name="create-new-assignment"></a>Создать новое назначение
Если у вас еще нет назначения, создайте его, нажав кнопку **назначить политику**.

[![Создать назначение](media/vminsights-enable-policy/create-assignment.png)](media/vminsights-enable-policy/create-assignment.png#lightbox)

Это та же страница, которая позволяет назначить инициативу в политике Azure, за исключением того, что она жестко определена в выбранной области и в определении инициативы **включить VM Insights** . При необходимости можно изменить **имя назначения** и добавить **Описание**. Выберите **исключения** , если требуется предоставить исключение для области. Например, ваша область может быть группой управления, а в этой группе управления можно указать подписку, которая будет исключена из назначения.

[![Назначить инициативу](media/vminsights-enable-policy/assign-initiative.png)](media/vminsights-enable-policy/assign-initiative.png#lightbox)

На странице **Параметры** выберите **рабочую область log Analytics** , которая будет использоваться всеми виртуальными машинами в назначении. Если вы хотите указать разные рабочие области для разных виртуальных машин, необходимо создать несколько назначений, каждая из которых имеет собственную область. 

   > [!NOTE]
   > Если рабочая область находится за пределами области назначения, предоставьте разрешения *участника Log Analytics* для идентификатора участника назначения политики. Если этого не сделать, может отобразиться ошибка развертывания `The client '343de0fe-e724-46b8-b1fb-97090f7054ed' with object id '343de0fe-e724-46b8-b1fb-97090f7054ed' does not have authorization to perform action 'microsoft.operationalinsights/workspaces/read' over scope ...`

[![Рабочей области](media/vminsights-enable-policy/assignment-workspace.png)](media/vminsights-enable-policy/assignment-workspace.png#lightbox)

Щелкните **проверить + создать** , чтобы проверить сведения о назначении перед нажатием кнопки **создать** , чтобы создать его. Не создавайте задачу исправления на этом этапе, так как вам, скорее всего, потребуется несколько задач исправления, чтобы включить существующие виртуальные машины. См. статью [исправление результатов проверки соответствия](#remediate-compliance-results) ниже.

## <a name="review-compliance"></a>Проверка соответствия
После создания назначения вы можете просматривать и контролировать покрытие для инициативы **Включение VM Insights** в группах управления и подписках. Это позволит увидеть, сколько виртуальных машин существует в каждой из групп управления или подписок, а также их состояние соответствия.

[![Страница "Управление политикой" для VM Insights](media/vminsights-enable-policy/manage-policy-page-01.png)](media/vminsights-enable-policy/manage-policy-page-01.png#lightbox)


В следующей таблице представлено описание сведений в этом представлении.

| Компонент | Описание | 
|----------|-------------| 
| **Область** | Группа управления и подписки, к которым вы имеете доступ или которые наследуются с возможностью детализации по иерархии группы управления.|
| **Роль** | Роль в области, которая может быть читателя, владельцем или участником. Это поле будет пустым, если у вас есть доступ к подписке, но не к группе управления, к которой он принадлежит. Эта роль определяет, какие данные можно просматривать и какие действия можно выполнять с точки зрения назначения политик или инициатив (владельца), их редактирования или просмотра соответствия. |
| **Всего виртуальных машин** | Общее число виртуальных машин в этой области, независимо от их состояния. Для группы управления это общая сумма виртуальных машин, вложенных в подписки или дочерние группы управления. |
| **Покрытие назначений** | Процент виртуальных машин, охваченных инициативой. |
| **Состояние назначения** | **Успешно** — все виртуальные машины в области имеют развернутые log Analytics и агенты зависимостей.<br>**Предупреждение** . Подписка не входит в группу управления.<br>**Не запущено** — Добавлено новое назначение.<br>**Блокировка** — у вас нет необходимых прав доступа к группе управления.<br>**Пусто** — виртуальные машины не существуют, или политика не назначена. |
| **Совместимые виртуальные машины** | Число соответствующих виртуальных машин. это количество виртуальных машин, на которых установлен агент Log Analytics и агент зависимостей. Это поле будет пустым, если назначения отсутствуют, в области нет виртуальных машин или несоответствующих разрешений. |
| **Соответствие** | Общий номер соответствия — это сумма отдельных ресурсов, которые соответствуют сумме всех различных ресурсов. |
| **Состояние соответствия** | **Соответствует** . все виртуальные машины в области виртуальных машин имеют log Analytics и агенты зависимостей, развернутые на них, или все новые виртуальные машины в области, подлежащие назначению, еще не были оценены.<br>**Не соответствует** . существуют виртуальные машины, которые были оценены, но не включены и могут потребовать исправления.<br>**Не запущено** — Добавлено новое назначение.<br>**Блокировка** — у вас нет необходимых прав доступа к группе управления.<br>**Пусто** — политика не назначена.  |


При назначении инициативы область, выбранная в назначении, может быть указанной областью или ее подмножеством. Например, вы могли создать назначение для подписки (область политики), а не группы управления (область охвата). В этом случае значение **покрытия назначений** указывает на виртуальные машины в области действия инициативы, разделенные виртуальными машинами в области покрытия. В другом случае вы могли исключить некоторые виртуальные машины, группы ресурсов или подписку из области политики. Если значение пустое, это означает, что политика или инициатива не существует или у вас нет разрешения. Сведения предоставляются в разделе **состояние назначения**.


## <a name="remediate-compliance-results"></a>Исправление результатов проверки соответствия
Инициатива будет применена к виртуальным машинам по мере их создания или изменения, но не будет применяться к существующим виртуальным машинам. Если для назначения не отображается соответствие 100%, создайте задачи исправления, чтобы оценить и включить существующие виртуальные машины, выберите **Просмотреть соответствие** , нажав кнопку с многоточием (...).

[![Просмотр соответствия](media/vminsights-enable-policy/view-compliance.png)](media/vminsights-enable-policy/view-compliance.png#lightbox)

На странице **соответствие** перечислены назначения, соответствующие заданному фильтру, и их соответствие требованиям. Щелкните назначение, чтобы просмотреть сведения о нем.

[![Соответствие политикам для виртуальных машин Azure](./media/vminsights-enable-policy/policy-view-compliance.png)](./media/vminsights-enable-policy/policy-view-compliance.png#lightbox)

На странице **соответствие требованиям для инициативы** перечислены определения политик в рамках инициативы, а также указано, соответствуют ли они требованиям.

[![Сведения о соответствии](media/vminsights-enable-policy/compliance-details.png)](media/vminsights-enable-policy/compliance-details.png#lightbox)

Щелкните определение политики, чтобы просмотреть сведения о нем. В сценариях определения политик, которые будут отображаться как несоответствие, входят следующие.

* Агент Log Analytics или агент зависимостей не развернут. Создайте задачу исправления для устранения неполадок.
* Образ виртуальной машины (ОС) не определен в определении политики. Условия политики развертывания включают в себя только виртуальные машины, развернутые на основе известных образов виртуальных машин Azure. Проверьте документацию, чтобы узнать, поддерживается ли ОС виртуальных машин.
* Виртуальные машины не подписывается в указанную рабочую область Log Analytics. Некоторые виртуальные машины в области действия инициативы подключены к рабочей области Log Analytics, отличной от указанной в назначении политики.

[![Сведения о соответствии политике](media/vminsights-enable-policy/policy-compliance-details.png)](media/vminsights-enable-policy/policy-compliance-details.png#lightbox)

Чтобы создать задачу исправления для устранения проблем с соответствием, щелкните **создать задачу исправления**. 

[![Новая задача по исправлению](media/vminsights-enable-policy/new-remediation-task.png)](media/vminsights-enable-policy/new-remediation-task.png#lightbox)

Щелкните **исправить** , чтобы создать задачу исправления, а затем **исправьте** ее, чтобы запустить ее. Скорее всего, потребуется создать несколько задач исправления, по одной для каждого определения политики. Невозможно создать задачу исправления для инициативы.

[![Снимок экрана: панель "исправление политик" для монитора | Виртуальные машины.](media/vminsights-enable-policy/remediation.png)](media/vminsights-enable-policy/remediation.png#lightbox)


После завершения задач по исправлению виртуальные машины должны быть совместимы с агентами, установленными и включенными для аналитики виртуальных машин. 

## <a name="next-steps"></a>Дальнейшие действия

Теперь, когда наблюдение включено для виртуальных машин, эти сведения доступны для анализа с помощью VM Insights. 

- Чтобы просмотреть зависимости обнаруженных приложений, см. статью [Просмотр схемы VM Insights](vminsights-maps.md). 
- Чтобы определить узкие места и общее использование с производительностью виртуальной машины, см. статью [Просмотр производительности виртуальной машины Azure](vminsights-performance.md).
