---
title: Поддержка уровня архива (Предварительная версия)
description: Дополнительные сведения о поддержке архивных уровней для Azure Backup
ms.topic: conceptual
ms.date: 02/18/2021
ms.openlocfilehash: cd9cfc5722dc644dd257738be797f162ac6dc995
ms.sourcegitcommit: c27a20b278f2ac758447418ea4c8c61e27927d6a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/03/2021
ms.locfileid: "101746911"
---
# <a name="archive-tier-support-preview"></a>Поддержка уровня архива (Предварительная версия)

Клиенты используют Azure Backup для хранения резервных копий данных, в том числе данные резервного копирования Long-Term хранения (LTR) с требованиями к хранению, определяемые правилами соответствия Организации. В большинстве случаев более старые данные резервного копирования редко обращаются и хранятся только для соответствия требованиям.

Azure Backup поддерживает резервное копирование долгосрочных точек хранения на уровне архива в дополнение к моментальным снимкам и уровню Standard.

## <a name="scope-for-preview"></a>Область для предварительного просмотра

Поддерживаемые рабочие нагрузки:

- Виртуальные машины Azure
  - Только ежемесячные и ежегодные точки восстановления. Ежедневные и еженедельные точки восстановления не поддерживаются.
  - Возраст >= 3 месяца на уровне Vault-Standard
  - Удержание Left >= 6 месяцев
  - Нет активных ежедневных и еженедельных зависимостей
- SQL Server на виртуальных машинах Azure
  - Только полные точки восстановления. Журналы и разностные копии не поддерживаются.
  - Возраст >= 45 дней на уровне Vault-Standard
  - Удержание Left >= 6 месяцев
  - Не содержит зависимостей

Поддерживаемые клиенты:

- Эта возможность предоставляется с помощью PowerShell.

## <a name="get-started-with-powershell"></a>Начало работы с PowerShell

1. Скачайте [последнюю версию модуля PowerShell](https://github.com/Azure/azure-powershell/tree/Az.RecoveryServices-preview) (Предварительная версия).
1. Подключитесь к Azure с помощью командлета [Connect-азаккаунт](https://docs.microsoft.com/powershell/module/az.accounts/connect-azaccount) .
1. Войдите в подписку:

   `Set-AzContext -Subscription "SubscriptionName"`

## <a name="use-powershell"></a>Использование PowerShell

### <a name="check-archivable-recovery-points"></a>Проверка архивных точек восстановления

```azurepowershell
$rp = Get-AzRecoveryServicesBackupRecoveryPoint -StartDate (Get-Date).AddDays(-180).ToUniversalTime() -EndDate (Get-Date).AddDays(0).ToUniversalTime() -VaultId $vault.ID -Item $bckItm  -IsReadyForMove $true -TargetTier VaultArchive
```

Будут перечислены все точки восстановления, связанные с определенным элементом архивации, готовыми к перемещению в архив.

### <a name="check-why-a-recovery-point-cannot-be-moved-to-archive"></a>Проверьте, почему точка восстановления не может быть перемещена в архив

```azurepowershell
$rp.RecoveryPointMoveReadinessInfo["ArchivedRP"]
```

Где `$rp[0]` — это точка восстановления, для которой необходимо проверить, почему она не является архивной.

Пример результатов выполнения:

```output
IsReadyForMove  AdditionalInfo
--------------  --------------
False           Recovery-Point Type is not eligible for archive move as it is already moved to archive tier
```

### <a name="check-recommended-set-of-archivable-points-only-for-azure-vms"></a>Проверка рекомендуемого набора архивных точек (только для виртуальных машин Azure)

Точки восстановления, связанные с виртуальной машиной, по своей природе являются добавочными. При перемещении определенной точки восстановления в архив она преобразуется в полную резервную копию, а затем перемещается в архив. Поэтому снижение затрат, связанное с перемещением в архив, зависит от изменения источника данных.

Таким образом, Azure Backup выдает рекомендованный набор точек восстановления, что может привести к снижению затрат при одновременном перемещении.

>[!NOTE]
>Экономия затрат зависит от ряда причин и может не совпадать для двух экземпляров.

```azurepowershell
$recommendedRPs = SGet-AzRecoveryServicesRecommendedArchivableRPGroup -Item $BackupItem -StartDate $Startdate.ToUniversalTime() -EndDate $Enddate.ToUniversalTime() -VaultId $vault.ID 
```

### <a name="move-to-archive"></a>Переместить в архив

```azurepowershell
Move-AzRecoveryServicesRecoveryPoint -VaultId $vault.ID - RecoveryPoint $RecoveryPoint[10] -SourceTier VaultStandard -DestinationTier VaultArchive 
```

Эта команда перемещает архивированную точку восстановления в архив. Он возвращает задание, которое можно использовать для отслеживания операции перемещения с портала и с помощью PowerShell.

### <a name="view-archived-recovery-points"></a>Просмотр архивных точек восстановления

Эта команда возвращает все архивированные точки восстановления.

```azurepowershell
$rp = Get-AzRecoveryServicesBackupRecoveryPoint -StartDate (Get-Date).AddDays(-180).ToUniversalTime() -EndDate (Get-Date).AddDays(0).ToUniversalTime() -VaultId $vault.ID -Item $bckItm -Tier VaultArchive
```

### <a name="restore-with-powershell"></a>Восстановление с помощью PowerShell

Для точек восстановления в архиве Azure Backup предоставляет встроенную методологию восстановления.

Интегрированное восстановление состоит из двух этапов. Первый шаг состоит в восстановлении точек восстановления, хранящихся в архиве, и временном хранении их на уровне "Стандартный" хранилища (также известной как длительность восстановления) от периода от 10 до 30 дней. Значение по умолчанию — 15 дней. Существует два разных приоритета — "Стандартный" и "высокий". Дополнительные сведения о [приоритете rehydratи](https://docs.microsoft.com/azure/storage/blobs/storage-blob-rehydration#rehydrate-an-archived-blob-to-an-online-tier).

>[!NOTE]
>
>- Продолжительность восстановления после выбора не может быть изменена, и восстановленные точки восстановления остаются на уровне Standard для продолжительности восстановления.
>- Дополнительный шаг к восстановлению влечет за собой стоимость.

Дополнительные сведения о различных методах восстановления для виртуальных машин Azure см. в статье [Восстановление виртуальной машины Azure с помощью PowerShell](backup-azure-vms-automation.md#restore-an-azure-vm).

```azurepowershell
Restore-AzRecoveryServicesBackupItem -VaultLocation $vault.Location -RehydratePriority "Standard" -RehydrateDuration 15 -RecoveryPoint $rp -StorageAccountName "SampleSA" -StorageAccountResourceGroupName "SArgName" -TargetResourceGroupName $vault.ResourceGroupName -VaultId $vault.ID
```

Чтобы восстановить SQL Server, выполните следующие [действия](backup-azure-sql-automation.md#restore-sql-dbs). Требуются дополнительные параметры — **рехидратионприорити** и **рехидратиондуратион**.

### <a name="view-jobs-from-powershell"></a>Просмотр заданий из PowerShell

Чтобы просмотреть задания перемещения и восстановления, используйте следующий командлет PowerShell:

```azurepowershell
Get-AzRecoveryservicesBackupJob -VaultId $targetVault.ID
```

## <a name="use-the-portal"></a>Использование портала

### <a name="check-archived-recovery-point"></a>Проверить архивную точку восстановления

Теперь можно просмотреть все точки восстановления, которые были перемещены в архив.

![Все точки восстановления.](./media/archive-tier-support/restore-points.png)

### <a name="restore-in-the-portal"></a>Восстановление на портале

Для точек восстановления, которые были перемещены в архив, необходимо добавить параметры для длительности и приоритета восстановления.

![Восстановление на портале.](./media/archive-tier-support/restore-in-portal.png)

### <a name="view-jobs-in-the-portal"></a>Просмотр заданий на портале

![Просмотр заданий на портале.](./media/archive-tier-support/view-jobs-portal.png)

### <a name="modify-protection"></a>Изменение защиты

Существует два способа изменения защиты для источника данных.

- Изменение существующей политики
- Защита источника данных с помощью новой политики

В обоих случаях новая политика применяется ко всем старым точкам восстановления, которые находятся на уровне Standard и на уровне архива. Поэтому старые точки восстановления могут быть удалены при изменении политики.

Когда точки восстановления перемещаются в архив, они подвергаются периоду раннего удаления 180 дней. Плата распределяется пропорционально. Если точка восстановления, которая еще не неизменности в архиве в течение 180 дней, будет удалена, она повлечет за собой стоимость, эквивалентную 180 минус число дней, потраченных на стандартный уровень.

Точки восстановления, которые не неизменности в архиве в течение шести месяцев, приводят к удалению по мере удаления.

## <a name="stop-protection-and-delete-data"></a>Снятие защиты и удаление данных

Отключить защиту и удалить данные удаляет все точки восстановления. Для точек восстановления в архиве, которые не неизменности в течение 180 дней на уровне архива, удаление точек восстановления приведет к раннему удалению.

## <a name="error-codes-and-troubleshooting-steps"></a>Коды ошибок и действия по устранению неполадок

Существует несколько кодов ошибок, которые возникают, когда точка восстановления не может быть перемещена в архив.

### <a name="recoverypointtypenoteligibleforarchive"></a>рековерипоинттипенотелигиблефорарчиве

**Сообщение об ошибке** -Recovery-Point тип не подходит для перемещения архива

**Описание** — этот код ошибки отображается, если выбранный тип точки восстановления не может быть перемещен в архив.

**Рекомендуемое действие** — проверка допустимости [точки восстановления](#scope-for-preview)

### <a name="recoverypointhaveactivedependencies"></a>рековерипоинсавеактиведепенденЦиес

**Сообщение об ошибке** -Recovery-Point наличие активных зависимостей для восстановления не подходит для перемещения архива

**Описание —** Выбранная точка восстановления имеет активные зависимости, поэтому ее нельзя переместить в архив.

**Рекомендуемое действие** — проверка допустимости [точки восстановления](#scope-for-preview)

### <a name="minlifespaninstandardrequiredforarchive"></a>минлифеспанинстандардрекуиредфорарчиве

**Сообщение об ошибке** — Recovery-Point не подходит для перемещения архивов, так как в хранилище уже затрачено время существования. уровень "Стандартный" меньше необходимого минимума

**Описание** — точка восстановления должна оставаться на уровне Standard в течение трех месяцев для виртуальных машин azure и 45 дней для SQL Server на виртуальных машинах Azure.

**Рекомендуемое действие** — проверка допустимости [точки восстановления](#scope-for-preview)

### <a name="minremaininglifespaninarchiverequired"></a>минремаининглифеспанинарчиверекуиред

**Сообщение об ошибке** -Recovery-Point оставшийся срок жизни меньше требуемого минимума.

**Описание** — минимальный срок существования, необходимый для точки восстановления для права на перемещение архива, составляет шесть месяцев.

**Рекомендуемое действие** — проверка допустимости [точки восстановления](#scope-for-preview)

### <a name="usererrorrecoverypointalreadyinarchivetier"></a>усерерроррековерипоинталреадинарчиветиер

**Сообщение об ошибке** -Recovery-Point не подходит для перемещения архива, так как он уже перемещен на уровень архива

**Описание** — Выбранная точка восстановления уже находится в архиве. Поэтому он не может быть перемещен в архив.

### <a name="usererrordatasourcetypeisnotsupportedforrecommendationapi"></a>усереррордатасаурцетипеиснотсуппортедфоррекоммендатионапи

**Сообщение об ошибке** — Тип DataSource не подходит для API рекомендаций.

**Описание** — API рекомендации применим только к виртуальным машинам Azure. Он неприменим для выбранного типа источника данных.

### <a name="usererrorrecoverypointalreadyrehydrated"></a>усерерроррековерипоинталреадирехидратед

**Сообщение об ошибке** — точка восстановления уже восстановлена. Восстановление не разрешено для этой RP.

**Описание** — Выбранная точка восстановления уже восстановлена.

### <a name="usererrorrecoverypointisnoteligibleforarchivemove"></a>усерерроррековерипоинтиснотелигиблефорарчивемове

**Сообщение об ошибке** — точка восстановления не подходит для перемещения архива.

**Описание** — Выбранная точка восстановления не может быть перемещена в архив.

### <a name="usererrorrecoverypointnotrehydrated"></a>усерерроррековерипоинтнотрехидратед

**Сообщение** **об ошибке** -архивная точка восстановления не восстанавливается. Повторите восстановление после завершения восстановления в архиве RP.

**Описание** — точка восстановления не восстанавливается. Попробуйте восстановить после восстановления точки восстановления.

### <a name="usererrorrecoverypointrehydrationnotallowed"></a>усерерроррековерипоинтрехидратионноталловед

**Сообщение** **об ошибке** — Повторное восстановление поддерживается только для резервных точек восстановления. Восстановление поддерживается только для архивных точек восстановления.

**Описание** — восстановление для выбранной точки восстановления запрещено.

### <a name="usererrorrecoverypointrehydrationalreadyinprogress"></a>усерерроррековерипоинтрехидратионалреадинпрогресс

**Сообщение об ошибке** : восстановление уже In-Progress для архивации точки восстановления.

**Описание** — восстановление для выбранной точки восстановления уже выполняется.

### <a name="rpmovenotsupportedduetoinsufficientretention"></a>рпмовенотсуппортеддуетоинсуффиЦиентретентион

**Сообщение об ошибке** — невозможно переместить точку восстановления на архивный уровень из-за нехватки длительности хранения в политике

**Рекомендуемое действие** — Обновите политику для защищенного элемента с соответствующим параметром хранения и повторите попытку.

### <a name="rpmovereadinesstobedetermined"></a>рпмовереадинесстобедетерминед

**Сообщение об ошибке** — мы по-прежнему определяем, можно ли перемещать эту точку восстановления.

**Описание** : готовность к перемещению точки восстановления еще не определена.

**Рекомендуемое действие** — проверьте еще раз время ожидания.

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы

### <a name="what-will-happen-to-archive-recovery-points-if-i-stop-protection-and-retain-data"></a>Что произойдет при архивации точек восстановления, если отключить защиту и сохранить данные?

Точка восстановления останется в архиве непрерывно. Дополнительные сведения см. [в разделе влияние отключения защиты на точки восстановления](manage-recovery-points.md#impact-of-stop-protection-on-recovery-points).

## <a name="next-steps"></a>Дальнейшие действия

- [Цены на Azure Backup](azure-backup-pricing.md)
